from pyspark import SparkConf, SparkContext
import requests
import time

#sceng, min, max
def add_params(x):

    return [(x,0,0,37999),(x,1,38000,40000),(x,0,40001,"")]

def get_totalpage(x):

    my_params = {'page': 1,  # 搜尋參數
                 'area': x[0],  # 指定區域
                 'scmax': x[3],
                 'scmin': x[2],
                 'sceng': x[1],
                 'scstrict': 1,
                 'sctp': "M"
                 }
    headers = {
        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36',
        'Referer': 'https://www.104.com.tw/job/',
        'Content-Type': 'application/json'
    }
    searchpageurl = 'https://www.104.com.tw/jobs/search/list?ro=0&order=11&asc=0&page=0&jobsource=2018indexpoc'

    try:
        res = requests.get(
            url=searchpageurl,
            headers=headers,
            params=my_params)

        totalpage = int(res.json()["data"]["totalPage"])
        if totalpage !=0:
            return (x[0],x[1],x[2],x[3],totalpage)
        else:
            pass
    except:
        pass

def get_url(x):

    q = []

    my_params = {'page': x[-1],  # 搜尋參數
                 'area': x[0],  # 指定區域
                 'scmax': x[3],
                 'scmin': x[2],
                 'sceng': x[1],
                 'scstrict': 1,
                 'sctp': "M"
                 }
    headers = {
        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36',
        'Referer': 'https://www.104.com.tw/job/',
        'Content-Type': 'application/json'
    }
    searchpageurl = 'https://www.104.com.tw/jobs/search/list?ro=0&order=11&asc=0&page=0&jobsource=2018indexpoc'
    try:
        res = requests.get(
            url=searchpageurl,
            headers=headers,
            params=my_params,
            timeout=10)

        for job in res.json()["data"]["list"]:
            index5 = job["link"]["job"].split('?')[0].split('/')[-1]
            if index5 != "trans_job_to_case.cfm":
                q.append(index5)

        return q

    except:

        pass

def url_to_json(x):

    headers = {
        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36',
        'Referer': 'https://www.104.com.tw/job/',
        'Content-Type': 'application/json'
    }

    try:
        res = requests.get(
            url="https://www.104.com.tw/job/ajax/content/"+x,
            headers=headers,
            #timeout=10
        )
        return res.json()
    except Exception as e:
        return e

def rm_none(x):
    if x == None:
        return False
    else:
        return True

def unfold_totalpage(x):
    l= []
    for i in range(1,x[-1]+1):
        l.append((x[0],x[1],x[2],x[3],i))
    return l

if __name__ == '__main__':

    sc = SparkContext()

    arealist = ['6001001001', '6001001002', '6001001003', '6001001004', '6001001005', '6001001006', '6001001007',
                '6001001008', '6001001009', '6001001010', '6001001011', '6001001012', '6001002001', '6001002002',
                '6001002003', '6001002004', '6001002005', '6001002006', '6001002007', '6001002008', '6001002009',
                '6001002010', '6001002011', '6001002012', '6001002013', '6001002014', '6001002015', '6001002016',
                '6001002017', '6001002018', '6001002019', '6001002020', '6001002021', '6001002022', '6001002023',
                '6001002024', '6001002025', '6001002026', '6001002027', '6001002028', '6001002029', '6001003001',
                '6001003002', '6001003003', '6001003004', '6001003005', '6001003006', '6001003007', '6001003008',
                '6001003009', '6001003010', '6001003011', '6001003012', '6001004001', '6001004002', '6001004003',
                '6001004004', '6001004005', '6001004006', '6001004007', '6001005001', '6001005002', '6001005003',
                '6001005004', '6001005005', '6001005006', '6001005007', '6001005008', '6001005009', '6001005010',
                '6001005011', '6001005012', '6001005013', '6001006001', '6001006002', '6001006003', '6001006004',
                '6001006005', '6001006006', '6001006007', '6001006008', '6001006009', '6001006010', '6001006011',
                '6001006012', '6001006013', '6001006014', '6001007001', '6001007002', '6001007003', '6001007004',
                '6001007005', '6001007006', '6001007007', '6001007008', '6001007009', '6001007010', '6001007011',
                '6001007012', '6001007013', '6001007014', '6001007015', '6001007016', '6001007017', '6001007018',
                '6001008001', '6001008002', '6001008003', '6001008004', '6001008005', '6001008006', '6001008007',
                '6001008008', '6001008009', '6001008010', '6001008011', '6001008012', '6001008013', '6001008014',
                '6001008015', '6001008016', '6001008017', '6001008018', '6001008019', '6001008020', '6001008021',
                '6001008022', '6001008023', '6001008024', '6001008025', '6001008026', '6001008027', '6001008028',
                '6001008029', '6001010001', '6001010002', '6001010003', '6001010004', '6001010005', '6001010006',
                '6001010007', '6001010008', '6001010009', '6001010010', '6001010011', '6001010012', '6001010013',
                '6001010014', '6001010015', '6001010016', '6001010017', '6001010018', '6001010019', '6001010020',
                '6001010021', '6001010022', '6001010023', '6001010024', '6001010025', '6001010026', '6001011001',
                '6001011002', '6001011003', '6001011004', '6001011005', '6001011006', '6001011007', '6001011008',
                '6001011009', '6001011010', '6001011011', '6001011012', '6001011013', '6001012001', '6001012002',
                '6001012003', '6001012004', '6001012005', '6001012006', '6001012007', '6001012008', '6001012009',
                '6001012010', '6001012011', '6001012012', '6001012013', '6001012014', '6001012015', '6001012016',
                '6001012017', '6001012018', '6001012019', '6001012020', '6001013001', '6001013002', '6001013003',
                '6001013004', '6001013005', '6001013006', '6001013007', '6001013008', '6001013009', '6001013010',
                '6001013011', '6001013012', '6001013013', '6001013014', '6001013015', '6001013016', '6001013017',
                '6001013018', '6001013019', '6001014001', '6001014002', '6001014003', '6001014004', '6001014005',
                '6001014006', '6001014007', '6001014008', '6001014009', '6001014010', '6001014011', '6001014012',
                '6001014013', '6001014014', '6001014015', '6001014016', '6001014017', '6001014018', '6001014019',
                '6001014020', '6001014021', '6001014022', '6001014023', '6001014024', '6001014025', '6001014026',
                '6001014027', '6001014028', '6001014029', '6001014030', '6001014031', '6001014032', '6001014033',
                '6001014034', '6001014035', '6001014036', '6001014037', '6001016001', '6001016002', '6001016003',
                '6001016004', '6001016005', '6001016006', '6001016007', '6001016008', '6001016009', '6001016010',
                '6001016011', '6001016012', '6001016013', '6001016014', '6001016015', '6001016016', '6001016017',
                '6001016018', '6001016019', '6001016020', '6001016021', '6001016022', '6001016023', '6001016024',
                '6001016025', '6001016026', '6001016027', '6001016028', '6001016029', '6001016030', '6001016031',
                '6001016032', '6001016033', '6001016034', '6001016035', '6001016036', '6001016037', '6001016038',
                '6001018001', '6001018002', '6001018003', '6001018004', '6001018005', '6001018006', '6001018007',
                '6001018008', '6001018009', '6001018010', '6001018011', '6001018012', '6001018013', '6001018014',
                '6001018015', '6001018016', '6001018017', '6001018018', '6001018019', '6001018020', '6001018021',
                '6001018022', '6001018023', '6001018024', '6001018025', '6001018026', '6001018027', '6001018028',
                '6001018029', '6001018030', '6001018031', '6001018032', '6001018033', '6001019001', '6001019002',
                '6001019003', '6001019004', '6001019005', '6001019006', '6001019007', '6001019008', '6001019009',
                '6001019010', '6001019011', '6001019012', '6001019013', '6001019014', '6001019015', '6001019016',
                '6001020001', '6001020002', '6001020003', '6001020004', '6001020005', '6001020006', '6001020007',
                '6001020008', '6001020009', '6001020010', '6001020011', '6001020012', '6001020013', '6001021001',
                '6001021002', '6001021003', '6001021004', '6001021005', '6001021006', '6001022001', '6001022002',
                '6001022003', '6001022004', '6001022005', '6001022006', '6001023001', '6001023002', '6001023003',
                '6001023004']

    areardd = sc.parallelize(arealist)

    areardd2 = areardd.flatMap(add_params)

    totalpage = areardd2.map(get_totalpage).filter(rm_none)


    area_page = totalpage.flatMap(unfold_totalpage)

    urllist = area_page.flatMap(get_url).filter(rm_none)

    jsonlist = urllist.map(url_to_json)

    jsonlist.persist()

    start = time.time()
    print(jsonlist.take(10))
    print(time.time()-start)
